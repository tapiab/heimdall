# GitLab CI/CD configuration for Heimdall
# Builds for Linux, macOS, and Windows (x86_64 and ARM64)

stages:
  - docker
  - check
  - test
  - build

variables:
  CARGO_HOME: ${CI_PROJECT_DIR}/.cargo
  RUSTUP_HOME: ${CI_PROJECT_DIR}/.rustup
  NODE_VERSION: "20"
  RUST_TAURI_IMAGE: ${CI_REGISTRY_IMAGE}/rust-tauri:latest

# ====================
# Docker Stage
# ====================

docker:rust-tauri:
  stage: docker
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"${CI_REGISTRY}\":{\"auth\":\"$(echo -n ${CI_REGISTRY_USER}:${CI_REGISTRY_PASSWORD} | base64)\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor
      --context ${CI_PROJECT_DIR}
      --dockerfile ${CI_PROJECT_DIR}/docker/rust-tauri.Dockerfile
      --destination ${RUST_TAURI_IMAGE}
  rules:
    - changes:
        - docker/rust-tauri.Dockerfile
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual
      allow_failure: true

# ====================
# Check Stage
# ====================

lint:js:
  stage: check
  image: node:${NODE_VERSION}
  script:
    - npm ci
    - npm run test:run
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

lint:rust:
  stage: check
  image: $RUST_TAURI_IMAGE
  script:
    - cd src-tauri
    - rustup default stable
    - cargo fmt --check
    - cargo clippy -- -D warnings
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ====================
# Test Stage
# ====================

test:js:
  stage: test
  image: node:${NODE_VERSION}
  script:
    - npm ci
    - npm run test:run
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    reports:
      junit: junit.xml
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

test:rust:
  stage: test
  image: $RUST_TAURI_IMAGE
  script:
    - cd src-tauri
    - rustup default stable
    - cargo test --verbose
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ====================
# Build Stage - Linux
# ====================

build:linux-x86_64:
  stage: build
  image: $RUST_TAURI_IMAGE
  before_script:
    - curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | bash -
    - apt-get install -y nodejs
    - npm ci
  script:
    - npm run tauri:build
  artifacts:
    paths:
      - src-tauri/target/release/bundle/deb/*.deb
      - src-tauri/target/release/bundle/rpm/*.rpm
      - src-tauri/target/release/bundle/appimage/*.AppImage
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual

build:linux-arm64:
  stage: build
  image: $RUST_TAURI_IMAGE
  tags:
    - arm64
  before_script:
    - curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | bash -
    - apt-get install -y nodejs
    - npm ci
  script:
    - npm run tauri:build
  artifacts:
    paths:
      - src-tauri/target/release/bundle/deb/*.deb
      - src-tauri/target/release/bundle/appimage/*.AppImage
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual

# ====================
# Build Stage - macOS
# ====================

build:macos-x86_64:
  stage: build
  tags:
    - macos
    - x86_64
  before_script:
    - brew install gdal
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source $HOME/.cargo/env
    - rustup target add x86_64-apple-darwin
    - npm ci
  script:
    - npm run tauri:build -- --target x86_64-apple-darwin
  artifacts:
    paths:
      - src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
      - src-tauri/target/x86_64-apple-darwin/release/bundle/macos/*.app
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual

build:macos-arm64:
  stage: build
  tags:
    - macos
    - arm64
  before_script:
    - brew install gdal
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source $HOME/.cargo/env
    - rustup target add aarch64-apple-darwin
    - npm ci
  script:
    - npm run tauri:build -- --target aarch64-apple-darwin
  artifacts:
    paths:
      - src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg
      - src-tauri/target/aarch64-apple-darwin/release/bundle/macos/*.app
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual

# ====================
# Build Stage - Windows
# ====================

build:windows-x86_64:
  stage: build
  tags:
    - windows
    - x86_64
  variables:
    GDAL_HOME: C:\OSGeo4W
    PATH: ${GDAL_HOME}\bin;${PATH}
  before_script:
    - choco install -y osgeo4w
    - choco install -y nodejs-lts rust
    - refreshenv
    - npm ci
  script:
    - npm run tauri:build
  artifacts:
    paths:
      - src-tauri/target/release/bundle/msi/*.msi
      - src-tauri/target/release/bundle/nsis/*.exe
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual

build:windows-arm64:
  stage: build
  tags:
    - windows
    - arm64
  variables:
    GDAL_HOME: C:\OSGeo4W
    PATH: ${GDAL_HOME}\bin;${PATH}
  before_script:
    - choco install -y osgeo4w
    - choco install -y nodejs-lts rust
    - refreshenv
    - rustup target add aarch64-pc-windows-msvc
    - npm ci
  script:
    - npm run tauri:build -- --target aarch64-pc-windows-msvc
  artifacts:
    paths:
      - src-tauri/target/aarch64-pc-windows-msvc/release/bundle/msi/*.msi
      - src-tauri/target/aarch64-pc-windows-msvc/release/bundle/nsis/*.exe
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual

# ====================
# Release Job
# ====================

release:
  stage: build
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: build:linux-x86_64
      artifacts: true
    - job: build:linux-arm64
      artifacts: true
      optional: true
    - job: build:macos-x86_64
      artifacts: true
      optional: true
    - job: build:macos-arm64
      artifacts: true
      optional: true
    - job: build:windows-x86_64
      artifacts: true
      optional: true
    - job: build:windows-arm64
      artifacts: true
      optional: true
  script:
    - echo "Creating release ${CI_COMMIT_TAG}"
  release:
    tag_name: ${CI_COMMIT_TAG}
    name: "Release ${CI_COMMIT_TAG}"
    description: "Release ${CI_COMMIT_TAG}"
    assets:
      links:
        - name: "Linux x86_64 AppImage"
          url: "${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/src-tauri/target/release/bundle/appimage/heimdall_${CI_COMMIT_TAG}_amd64.AppImage"
        - name: "Linux x86_64 Deb"
          url: "${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/src-tauri/target/release/bundle/deb/heimdall_${CI_COMMIT_TAG}_amd64.deb"
  rules:
    - if: $CI_COMMIT_TAG
