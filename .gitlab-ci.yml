# GitLab CI/CD configuration for Heimdall
# Builds for Linux, macOS, and Windows (x86_64 and ARM64)

stages:
  - docker
  - check
  - test
  - build
  - release

variables:
  CARGO_HOME: ${CI_PROJECT_DIR}/.cargo
  RUSTUP_HOME: ${CI_PROJECT_DIR}/.rustup
  NODE_VERSION: "20"
  RUST_TAURI_IMAGE: ${CI_REGISTRY_IMAGE}/rust-tauri:latest

# ====================
# Docker Stage
# ====================

docker:rust-tauri:
  stage: docker
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"${CI_REGISTRY}\":{\"auth\":\"$(echo -n ${CI_REGISTRY_USER}:${CI_REGISTRY_PASSWORD} | base64)\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor
      --context ${CI_PROJECT_DIR}
      --dockerfile ${CI_PROJECT_DIR}/docker/rust-tauri.Dockerfile
      --destination ${RUST_TAURI_IMAGE}
  rules:
    - changes:
        - docker/rust-tauri.Dockerfile
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual
      allow_failure: true

# ====================
# Check Stage
# ====================

lint:js:
  stage: check
  image: node:${NODE_VERSION}
  script:
    - make ci-install
    - make ci-lint-js
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

lint:rust:
  stage: check
  image: $RUST_TAURI_IMAGE
  script:
    - rustup default stable
    - make ci-lint-rust
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# ====================
# Test Stage
# ====================

test:js:
  stage: test
  image: node:${NODE_VERSION}
  script:
    - make ci-install
    - make ci-test-js
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    reports:
      junit: junit.xml
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

test:rust:
  stage: test
  image: $RUST_TAURI_IMAGE
  script:
    - rustup default stable
    - make ci-test-rust
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# ====================
# Build Stage - Linux
# ====================

build:linux-x86_64:
  stage: build
  image: $RUST_TAURI_IMAGE
  before_script:
    - curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | bash -
    - apt-get install -y nodejs
    - rustup default stable
    - make ci-install
  script:
    - make ci-build
  artifacts:
    paths:
      - src-tauri/target/release/bundle/deb/*.deb
      - src-tauri/target/release/bundle/rpm/*.rpm
      - src-tauri/target/release/bundle/appimage/*.AppImage
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

build:linux-arm64:
  stage: build
  image: $RUST_TAURI_IMAGE
  tags:
    - arm64
  before_script:
    - curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | bash -
    - apt-get install -y nodejs
    - rustup default stable
    - make ci-install
  script:
    - make ci-build
  artifacts:
    paths:
      - src-tauri/target/release/bundle/deb/*.deb
      - src-tauri/target/release/bundle/appimage/*.AppImage
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ====================
# Build Stage - macOS
# ====================

build:macos-x86_64:
  stage: build
  tags:
    - macos
    - x86_64
  before_script:
    - brew install gdal
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source $HOME/.cargo/env
    - rustup default stable
    - rustup target add x86_64-apple-darwin
    - make ci-install
  script:
    - make ci-build-target TARGET=x86_64-apple-darwin
  artifacts:
    paths:
      - src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
      - src-tauri/target/x86_64-apple-darwin/release/bundle/macos/*.app
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

build:macos-arm64:
  stage: build
  tags:
    - macos
    - arm64
  before_script:
    - brew install gdal
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source $HOME/.cargo/env
    - rustup default stable
    - rustup target add aarch64-apple-darwin
    - make ci-install
  script:
    - make ci-build-target TARGET=aarch64-apple-darwin
  artifacts:
    paths:
      - src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg
      - src-tauri/target/aarch64-apple-darwin/release/bundle/macos/*.app
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ====================
# Build Stage - Windows
# ====================

build:windows-x86_64:
  stage: build
  tags:
    - windows
    - x86_64
  variables:
    GDAL_HOME: C:\OSGeo4W
    PATH: ${GDAL_HOME}\bin;${PATH}
  before_script:
    - choco install -y osgeo4w
    - choco install -y nodejs-lts rust make
    - rustup default stable
    - refreshenv
    - make ci-install
  script:
    - make ci-build
  artifacts:
    paths:
      - src-tauri/target/release/bundle/msi/*.msi
      - src-tauri/target/release/bundle/nsis/*.exe
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

build:windows-arm64:
  stage: build
  tags:
    - windows
    - arm64
  variables:
    GDAL_HOME: C:\OSGeo4W
    PATH: ${GDAL_HOME}\bin;${PATH}
  before_script:
    - choco install -y osgeo4w
    - choco install -y nodejs-lts rust make
    - rustup default stable
    - refreshenv
    - rustup target add aarch64-pc-windows-msvc
    - make ci-install
  script:
    - make ci-build-target TARGET=aarch64-pc-windows-msvc
  artifacts:
    paths:
      - src-tauri/target/aarch64-pc-windows-msvc/release/bundle/msi/*.msi
      - src-tauri/target/aarch64-pc-windows-msvc/release/bundle/nsis/*.exe
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ====================
# Release Stage
# ====================

release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: build:linux-x86_64
      artifacts: true
    - job: build:linux-arm64
      artifacts: true
      optional: true
    - job: build:macos-x86_64
      artifacts: true
      optional: true
    - job: build:macos-arm64
      artifacts: true
      optional: true
    - job: build:windows-x86_64
      artifacts: true
      optional: true
    - job: build:windows-arm64
      artifacts: true
      optional: true
  script:
    - echo "Creating release ${CI_COMMIT_TAG}"
    - |
      # Generate changelog from git log since previous tag
      PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${CI_COMMIT_TAG}^ 2>/dev/null || echo "")
      if [ -n "$PREVIOUS_TAG" ]; then
        CHANGELOG=$(git log ${PREVIOUS_TAG}..${CI_COMMIT_TAG} --pretty=format:"- %s (%h)" --no-merges)
      else
        CHANGELOG=$(git log ${CI_COMMIT_TAG} --pretty=format:"- %s (%h)" --no-merges -20)
      fi
      echo "CHANGELOG<<EOF" >> release.env
      echo "$CHANGELOG" >> release.env
      echo "EOF" >> release.env
    - cat release.env
  artifacts:
    reports:
      dotenv: release.env
  release:
    tag_name: ${CI_COMMIT_TAG}
    name: "Heimdall ${CI_COMMIT_TAG}"
    description: |
      ## What's Changed

      ${CHANGELOG}

      ## Downloads

      ### Linux
      - **x86_64**: AppImage, .deb, .rpm
      - **ARM64**: AppImage, .deb

      ### macOS
      - **Intel (x86_64)**: .dmg
      - **Apple Silicon (ARM64)**: .dmg

      ### Windows
      - **x86_64**: .msi, .exe
      - **ARM64**: .msi, .exe

      ---
      *Full changelog: ${CI_PROJECT_URL}/-/compare/${PREVIOUS_TAG}...${CI_COMMIT_TAG}*
    assets:
      links:
        - name: "Linux x86_64 AppImage"
          url: "${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/src-tauri/target/release/bundle/appimage/heimdall_${CI_COMMIT_TAG}_amd64.AppImage"
          filepath: "/binaries/heimdall_${CI_COMMIT_TAG}_linux_amd64.AppImage"
          link_type: package
        - name: "Linux x86_64 Deb"
          url: "${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/src-tauri/target/release/bundle/deb/heimdall_${CI_COMMIT_TAG}_amd64.deb"
          filepath: "/binaries/heimdall_${CI_COMMIT_TAG}_linux_amd64.deb"
          link_type: package
        - name: "Linux x86_64 RPM"
          url: "${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/src-tauri/target/release/bundle/rpm/heimdall-${CI_COMMIT_TAG}-1.x86_64.rpm"
          filepath: "/binaries/heimdall_${CI_COMMIT_TAG}_linux_amd64.rpm"
          link_type: package
  rules:
    - if: $CI_COMMIT_TAG
