# GitHub Actions CI/CD for Heimdall
# Builds for Linux, macOS, and Windows (x86_64 and ARM64)

name: CI

on:
  push:
    branches: [main]
    tags: ['*']
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  NODE_VERSION: '20'

jobs:
  # ====================
  # Check & Test
  # ====================

  lint-js:
    name: Lint JS
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: make ci-install
      - run: make ci-lint-js

  lint-rust:
    name: Lint Rust
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgdal-dev libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev
      - run: make ci-lint-rust

  test-js:
    name: Test JS
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: make ci-install
      - run: make ci-test-js

  test-rust:
    name: Test Rust
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgdal-dev libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev
      - run: make ci-test-rust

  # ====================
  # Build - Linux
  # ====================

  build-linux-x86_64:
    name: Build Linux x86_64
    runs-on: ubuntu-latest
    needs: [lint-js, lint-rust, test-js, test-rust]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgdal-dev libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev patchelf xdg-utils
      - run: make ci-install
      - run: make ci-build
      - uses: actions/upload-artifact@v4
        with:
          name: linux-x86_64
          path: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/rpm/*.rpm
            src-tauri/target/release/bundle/appimage/*.AppImage
          retention-days: 7

  build-linux-arm64:
    name: Build Linux ARM64
    runs-on: ubuntu-24.04-arm
    needs: [lint-js, lint-rust, test-js, test-rust]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgdal-dev libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev patchelf xdg-utils
      - run: make ci-install
      - run: make ci-build
      - uses: actions/upload-artifact@v4
        with:
          name: linux-arm64
          path: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/appimage/*.AppImage
          retention-days: 7

  # ====================
  # Build - macOS
  # ====================

  build-macos-arm64:
    name: Build macOS ARM64
    runs-on: macos-latest
    needs: [lint-js, lint-rust, test-js, test-rust]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
      - name: Install GDAL
        run: brew install gdal
      - run: make ci-install
      - run: make ci-build-target TARGET=aarch64-apple-darwin
      - uses: actions/upload-artifact@v4
        with:
          name: macos-arm64
          path: |
            src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg
          retention-days: 7

  build-macos-x86_64:
    name: Build macOS x86_64
    runs-on: macos-15-intel
    needs: [lint-js, lint-rust, test-js, test-rust]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
      - name: Install GDAL
        run: brew install gdal
      - run: make ci-install
      - run: make ci-build-target TARGET=x86_64-apple-darwin
      - uses: actions/upload-artifact@v4
        with:
          name: macos-x86_64
          path: |
            src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
          retention-days: 7

  # ====================
  # Build - Windows
  # ====================

  build-windows-x86_64:
    name: Build Windows x86_64
    runs-on: windows-latest
    needs: [lint-js, lint-rust, test-js, test-rust]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: false
          channels: conda-forge
      - name: Install GDAL
        shell: bash -el {0}
        run: |
          conda install -y gdal
          echo "GDAL_HOME=$CONDA_PREFIX" >> $GITHUB_ENV
          echo "$CONDA_PREFIX/Library/bin" >> $GITHUB_PATH
          echo "GDAL_DATA=$CONDA_PREFIX/Library/share/gdal" >> $GITHUB_ENV
          echo "PROJ_LIB=$CONDA_PREFIX/Library/share/proj" >> $GITHUB_ENV
      - name: Install dependencies
        run: npm ci
      - name: Build
        shell: bash -el {0}
        run: npm run tauri:build
      - uses: actions/upload-artifact@v4
        with:
          name: windows-x86_64
          path: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
          retention-days: 7

  # ====================
  # Release
  # ====================

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [build-linux-x86_64, build-linux-arm64, build-macos-arm64, build-macos-x86_64, build-windows-x86_64]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate changelog
        id: changelog
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${{ github.ref_name }}^ 2>/dev/null || echo "")
          
          if [ -n "$PREVIOUS_TAG" ]; then
            RANGE="${PREVIOUS_TAG}..${{ github.ref_name }}"
          else
            RANGE="${{ github.ref_name }}"
          fi
          
          # Generate changelog with commit messages
          CHANGELOG=$(git log $RANGE --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" --no-merges | head -50)
          
          # Get unique contributors (using git author email to find GitHub usernames via API)
          CONTRIBUTORS=""
          for email in $(git log $RANGE --pretty=format:"%ae" --no-merges | sort | uniq); do
            # Try to get GitHub username from commit
            username=$(git log $RANGE --author="$email" --pretty=format:"%an" -1)
            if [ -n "$username" ]; then
              CONTRIBUTORS="${CONTRIBUTORS}- ${username}\n"
            fi
          done
          CONTRIBUTORS=$(echo -e "$CONTRIBUTORS" | sort | uniq | grep -v '^$')
          
          echo "PREVIOUS_TAG=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
          
          # Use heredoc for multiline changelog
          {
            echo "changelog<<EOF_CHANGELOG"
            echo "$CHANGELOG"
            echo "EOF_CHANGELOG"
          } >> $GITHUB_OUTPUT
          
          # Use heredoc for multiline contributors
          {
            echo "contributors<<EOF_CONTRIBUTORS"
            echo "$CONTRIBUTORS"
            echo "EOF_CONTRIBUTORS"
          } >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Heimdall ${{ github.ref_name }}
          body: |
            ## What's Changed

            ${{ steps.changelog.outputs.changelog }}

            ## Contributors

            ${{ steps.changelog.outputs.contributors }}

            ## Downloads

            ### Linux
            - **x86_64**: AppImage, .deb, .rpm
            - **ARM64**: AppImage, .deb

            ### macOS
            - **Apple Silicon (ARM64)**: .dmg
            - **Intel (x86_64)**: .dmg

            ### Windows
            - **x86_64**: .msi, .exe

            ---
            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ steps.changelog.outputs.PREVIOUS_TAG }}...${{ github.ref_name }}
          files: |
            artifacts/**/*.deb
            artifacts/**/*.rpm
            artifacts/**/*.AppImage
            artifacts/**/*.dmg
            artifacts/**/*.msi
            artifacts/**/*.exe
          draft: false
          prerelease: false
          generate_release_notes: true
